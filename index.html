<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrabGest - Gestion de Brasserie</title>
    <!-- Polices Google -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <!-- Styles locaux -->
    <link rel="stylesheet" href="styles/theme.css">
    <link rel="stylesheet" href="styles/style.css">
    <!-- Font Awesome local -->
    <link rel="stylesheet" href="lib/font-awesome.min.css">
    <!-- Manifest pour PWA -->
    <link rel="manifest" href="manifest.json">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/images/crab-logo.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    // Initialiser jsPDF
    window.jspdf = window.jspdf.jsPDF;
</script>

<!-- Firebase SDK -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyC1ZP89QSoWubkcnMJJ6cinIAlFXXnTefU",
    authDomain: "crabbrewgest.firebaseapp.com",
    projectId: "crabbrewgest",
    storageBucket: "crabbrewgest.firebasestorage.app",
    messagingSenderId: "156226949050",
    appId: "1:156226949050:web:52b3e666cc31e7963d5783",
    measurementId: "G-MY8FH7L6K1"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

    <!-- CSP pour éviter les blocages -->
<meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline';
    connect-src 'self' https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data:;
    object-src 'none';
    frame-src 'none';
">

</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo-container">
                <img src="assets/images/crab-logo.png" alt="Logo CRAB" class="logo">
                <h1>CrabGest</h1>
            </div>
            <button class="menu-burger" id="menuBurger">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <nav class="tabs" id="mainNav">
            <button class="tab-button active" data-tab="stocks">Stocks</button>
            <button class="tab-button" data-tab="bieres">Bières</button>
            <button class="tab-button" data-tab="fermentation">Fermentation</button>
            <button class="tab-button" data-tab="conditionnement">Conditionnement</button>
            <button class="tab-button" data-tab="ventes">Ventes</button>
            <button class="tab-button" data-tab="douane">Douane</button>
        </nav>
    </header>

    <main>
        <!-- Stocks -->
        <section id="stocks" class="tab active">
            <h2>Gestion des Stocks</h2>
            <div class="card">
                <div class="form-group">
                    <button onclick="ouvrirModalAjoutIngredient()" class="btn btn-primary">
                        <i class="material-icons">add</i> Ajouter un ingrédient
                    </button>
                </div>
                <div class="table-responsive">
                    <label for="biere-select">Filtrer par bière :</label>
                    <select id="biere-select">
                    <option value="">-- Toutes les bières --</option>
                    <!-- Les options seront remplies dynamiquement via JavaScript -->
                    </select>

                    <table id="table-stocks" class="table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Nom</th>
                                <th>Lot</th>
                                <th>Quantité</th>
                                <th>Fournisseur</th>
                                <th>Spécification</th>
                                <th>Année</th>
                                <th>Conditionnement</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Formulaire de retrait de stock -->
                <div class="card">
                    <h3>Retirer du stock pour une bière</h3>
                    <div class="form-group">
                        <select id="select-ingredient-retrait" class="form-control">
                            <option value="">-- Ingrédient --</option>
                        </select>
                        <select id="select-biere-retrait" class="form-control">
                            <option value="">-- Bière --</option>
                        </select>
                        <input type="number" id="quantite-retrait" class="form-control" placeholder="Quantité (g)" min="1">
                        <button onclick="retirerStockPourBiere()" class="btn btn-primary">Retirer</button>
                    </div>
                    <div id="retrait-error" class="error-message"></div>
                </div>

                <!-- Historique des retraits -->
                <div class="card">
                    <h3>Historique des retraits</h3>
                    <div class="table-responsive">
                        <table id="historique-retraits" class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Ingrédient</th>
                                    <th>Quantité</th>
                                    <th>Bière</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Bières -->
        <section id="bieres" class="tab">
            <h2>Gestion des Bières</h2>
            <div class="card">
                <div class="form-group">
                    <input type="text" id="nom-biere" class="form-control" placeholder="Nom de la bière">
                    <input type="text" id="style-biere" class="form-control" placeholder="Style">
                    <input type="number" id="degre-biere" class="form-control" placeholder="Degré alcoolique" step="0.1">
                    <input type="number" id="volume-biere" class="form-control" placeholder="Volume (L)" step="0.1">
                    <button onclick="ajouterBiere()" class="btn btn-primary">Ajouter Bière</button>
                </div>
                <div class="table-responsive">
                    <table id="table-bieres" class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom</th>
                                <th>Style</th>
                                <th>Degré</th>
                                <th>Volume (L)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Fermentation -->
        <section id="fermentation" class="tab">
            <h2>Suivi de Fermentation</h2>
            <div class="card">
                <div class="form-group">
                    <select id="select-biere-fermentation" class="form-control">
                        <option value="">-- Sélectionner une bière --</option>
                    </select>
                </div>
                <div class="fermentation-actions">
                    <input type="datetime-local" id="date-action" class="form-control">
                    <select id="type-action" class="form-control">
                        <option value="densite">Densité (SG)</option>
                        <option value="temperature">Température (°C)</option>
                        <option value="purge">Purge (mL)</option>
                        <option value="pression">Pression (bars)</option>
                        <option value="dry_hopping">Dry Hopping (g)</option>
                    </select>
                    <input type="number" id="valeur-action" class="form-control" placeholder="Valeur" step="any">
                    <button onclick="ajouterActionFermentation()" class="btn btn-primary">Ajouter Action</button>
                </div>

                <h3>Actions de fermentation</h3>
                <div class="table-responsive">
                    <table id="fermentation-actions-table" class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Valeur</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="chart-container" style="height: 400px; margin-top: 20px; position: relative;">
                    <canvas id="fermentationChart"></canvas>
                </div>
            </div>
        </section>

<!-- Conditionnement -->
<section id="conditionnement" class="tab">
    <h2>Conditionnement</h2>
    <div class="card">
        <div class="form-group">
            <button onclick="ouvrirModaleAjoutConditionnement()" class="btn btn-primary">
                <i class="material-icons">add</i> Ajouter un conditionnement
            </button>
        </div>
        <div style="margin: 20px 0; display: flex; align-items: center;">
            <label for="listbox-bieres" style="margin-right: 10px;">Sélectionner une bière:</label>
            <select id="listbox-bieres" class="form-control" style="width: auto;"></select>
        </div>
        <div class="table-responsive">
            <table id="table-conditionnements" class="table">
                <thead>
                    <tr>
                        <th>Numéro de lot</th>
                        <th>Bière</th>
                        <th>ABV</th>
                        <th>Contenant</th>
                        <th>Quantité</th>
                        <th>Volume (L)</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</section>

<!-- Modale pour ajouter un conditionnement -->
<div id="modale-conditionnement" class="custom-modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Ajouter un conditionnement</h3>
        <form id="form-conditionnement">
            <div class="form-group">
                <label for="select-biere-conditionnement">Bière :</label>
                <select id="select-biere-conditionnement" class="form-control" required></select>
            </div>
            <div class="form-group">
                <label for="abv-final">ABV final :</label>
                <input type="number" id="abv-final" class="form-control" placeholder="ABV final" step="0.1" required>
            </div>
            <div class="form-group">
                <label for="type-contenant">Type de contenant :</label>
                <select id="type-contenant" class="form-control" required></select>
            </div>
            <div class="form-group">
                <label for="quantite-contenant">Quantité :</label>
                <input type="number" id="quantite-contenant" class="form-control" placeholder="Quantité" step="1" required>
            </div>
            <div class="form-group">
                <label for="date-conditionnement">Date :</label>
                <input type="date" id="date-conditionnement" class="form-control" required>
            </div>
            <button type="button" onclick="ajouterConditionnement()" class="btn btn-primary">Enregistrer</button>
        </form>
    </div>
</div>

<!-------------------->
<!-- Section Ventes -->
<!-------------------->
<section id="ventes" class="tab">
    <h2>Gestion des Ventes</h2>

    <!-- Section Clients -->
    <div class="card">
        <h3>Clients</h3>
        <div class="form-group">
            <select id="select-client" class="form-control">
                <option value="">-- Sélectionner un client --</option>
            </select>
            <button id="btn-nouveau-client" class="btn btn-primary">
                <i class="material-icons">person_add</i> Nouveau Client
            </button>
        </div>
        <div id="infos-client" class="client-info" style="display: none;">
            <h4>Informations du client</h4>
            <p><strong>Nom :</strong> <span id="client-nom"></span></p>
            <p><strong>Adresse :</strong> <span id="client-adresse"></span></p>
            <p><strong>SIRET :</strong> <span id="client-siret"></span></p>
            <p><strong>Email :</strong> <span id="client-email"></span></p>
        </div>
    </div>

  <!-- Section Stocks Disponibles -->
    <div class="card" id="stocks-disponibles-section">
          <h3>
        Stocks Disponibles
        <button id="btn-toggle-table-stocks" class="btn btn-primary" style="float: right; top: -80px">
            <i class="material-icons">visibility_off</i> Masquer le tableau
        </button>
        </h3>
        <select id="select-filtre-biere" class="form-control">
            <option value="">-- Filtrer par bière --</option>
        </select>
        </div>
         <div class="table-responsive" id="table-stocks-container" style="display: block;">
        <table id="table-stocks-disponibles" class="table">
            <thead>
                <tr>
                    <th>Bière</th>
                    <th>Type de Contenant</th>
                    <th>Numéro de Lot</th>
                    <th>Quantité Disponible</th>
                </tr>
            </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>


    <!-- Section Commande -->
    <div class="card">
        <h3>Nouvelle Commande</h3>
        <div class="form-group">
            <select id="select-biere-commande" class="form-control">
                <option value="">-- Sélectionner une bière --</option>
            </select>
            <select id="select-type-contenant-commande" class="form-control">
                <option value="">-- Sélectionner un contenant --</option>
            </select>
            <input type="number" id="quantite-commande" class="form-control" placeholder="Quantité" min="1">
            <div id="stock-disponible" style="font-weight: bold; margin-top: 5px;"></div>        
        </div>
        <input type="number" id="prix-unitaire-commande" class="form-control" placeholder="Prix unitaire" step="0.01" style="margin-right: 10px;">
            <button id="btn-ajouter-ligne" class="btn btn-primary">
                <i class="material-icons">add</i> Ajouter à la commande
            </button>
        <div id="stock-disponible" style="margin: 10px 0; font-weight: bold;"></div>
        
    </div>
        <div class="table-responsive">
            <table id="table-commande" class="table">
                <thead>
                    <tr>
                        <th>Bière</th>
                        <th>Type</th>
                        <th>Numéro de lot</th>
                        <th>Quantité</th>
                        <th>Prix unitaire</th>
                        <th>Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="form-group">
            <button id="btn-valider-commande" class="btn btn-primary">
                <i class="material-icons">check</i> Valider la commande
            </button>
            <button id="btn-generer-facture" class="btn btn-primary">
                <i class="material-icons">picture_as_pdf</i> Générer Facture
            </button>
        </div>
    </div>

    <!-- Section Historique des Ventes -->
    <div class="card">
        <h3>Historique des Ventes</h3>
        <div class="table-responsive">
            <table id="table-ventes" class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Client</th>
                        <th>Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</section>

<!-- Modale pour ajouter un client -->
<div id="modale-client" class="modal">
    <div class="modal-content">
        <span class="close" data-modal-id="modale-client">&times;</span>
        <h3>Nouveau Client</h3>
        <form id="form-client">
            <div class="form-group">
                <label for="nom-client">Nom :</label>
                <input type="text" id="nom-client" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="adresse-client">Adresse :</label>
                <textarea id="adresse-client" class="form-control" required></textarea>
            </div>
            <div class="form-group">
                <label for="siret-client">SIRET :</label>
                <input type="text" id="siret-client" class="form-control">
            </div>
            <div class="form-group">
                <label for="email-client">Email :</label>
                <input type="email" id="email-client" class="form-control">
            </div>
            <button type="button" id="btn-enregistrer-client" class="btn btn-primary">Enregistrer</button>
        </form>
    </div>
</section>


    <!-- Douane -->
    <section id="douane" class="tab">
        <h2>Déclarations Douanières</h2>
        <div class="card">
            <div class="form-group">
                <select id="select-mois-douane" class="form-control">
                    <option value="">-- Sélectionner un mois --</option>
                </select>
                <button onclick="genererDeclarationDouane()" class="btn btn-primary">Générer Déclaration</button>
            </div>
            <div class="table-responsive">
                <table id="table-douane" class="table">
                    <thead>
                        <tr>
                            <th>Mois</th>
                            <th>Bière</th>
                            <th>Volume (L)</th>
                            <th>ABV</th>
                            <th>Droits (€)</th>
                            <th>Lots</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </section>

    </main>

    <!-- Modales -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="editModalTitle">Éditer</h2>
            <form id="editForm"></form>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Confirmer la suppression</h2>
            <p id="deleteModalMessage">Êtes-vous sûr de vouloir supprimer cette entrée ?</p>
            <button id="confirmDelete" class="btn btn-danger">Supprimer</button>
            <button id="cancelDelete" class="btn">Annuler</button>
        </div>
    </div>

    <footer>
        <p>© 2026 CrabBrewGest - Association CRAB (Collectif Rennais des amateur·rice·s de bières)</p>
    </footer>

    <!-- Scripts locaux chargés à la fin du body -->
    <script src="scripts/db.js"></script>
    <script src="scripts/app.js"></script>
    <script src="scripts/modal.js"></script>
    <script src="scripts/stocks.js"></script>
    <script src="scripts/bieres.js"></script>
    <script src="scripts/fermentation.js"></script>
    <script src="scripts/conditionnement.js"></script>
    <script src="scripts/ventes.js"></script>
    <script src="scripts/douane.js"></script>
    <!-- Bibliothèques locales -->
    <script src="lib/chart.min.js"></script>
    <script src="lib/jspdf.umd.min.js"></script>
</body>
</html>
